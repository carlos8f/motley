#!/usr/bin/env node
var cmd = require('commander')
  , motley = require('../')
  , assert = require('assert')
  , fs = require('fs')
  , path = require('path')
  , exec = require('child_process').exec

cmd
  .usage('motley [path/to/project]')
  .version(require('../package.json').version)
  .option('-d, --cwd', 'motley project directory')
  .option('--install', 'install dependencies automatically')
  .option('--port <port>', 'specify listening port')
  .description('run a motley project')

cmd.parse(process.argv);

if (typeof cmd.port !== 'undefined') process.env.MOTLEY_PORT = cmd.port;

var motleyFile = (cmd.args[0] || '').replace(/\/$/, '')
  , cwd = cmd.cwd

if (!motleyFile) motleyFile = '.';

var stat = fs.statSync(motleyFile);
if (stat.isDirectory()) {
  cwd = path.resolve(motleyFile);
  motleyFile = 'motley.yml';
}
else if (stat.isFile()) {
  cwd = path.resolve(path.dirname(motleyFile));
  motleyFile = path.basename(motleyFile);
}

if (cmd.install) {
  exec('npm install', {cwd: cwd}, function (err, stdout, stderr) {
    assert.ifError(err);
    motley(motleyFile, cwd);
  });
}
else motley(motleyFile, cwd);
